# üì± Telegram Bot Integration Setup Guide

## Overview
The KHSolar app now supports sending system reports directly to customers via Telegram. This feature validates Telegram usernames and provides a button to send reports.

---

## ‚úÖ Features Implemented

### 1. **Telegram Username Validation**
- ‚úÖ Validates Telegram username format
- ‚úÖ Accepts usernames with or without @ symbol
- ‚úÖ Checks length (5-32 characters)
- ‚úÖ Allows only letters, numbers, and underscores
- ‚úÖ Stores clean username (without @)
- ‚úÖ Shows validation errors immediately

**Valid Examples:**
- `@sokpisey` ‚Üí Saved as `sokpisey`
- `john_doe123` ‚Üí Saved as `john_doe123`
- `user_2025` ‚Üí Saved as `user_2025`

**Invalid Examples:**
- `abc` ‚Üí Too short (< 5 chars)
- `user-name` ‚Üí Contains hyphen (only underscore allowed)
- `user name` ‚Üí Contains space
- `this_is_a_very_long_username_12345` ‚Üí Too long (> 32 chars)

### 2. **Send Report Button**
- ‚úÖ Appears in Total System Price section
- ‚úÖ Only visible if Telegram username provided
- ‚úÖ Shows recipient: @username
- ‚úÖ Currently shows setup message

---

## üöÄ How to Complete Telegram Integration

### Step 1: Create Telegram Bot

1. **Open Telegram** and search for `@BotFather`
2. **Send command:** `/newbot`
3. **Choose bot name:** e.g., "KHSolar Reports Bot"
4. **Choose bot username:** e.g., `khsolar_reports_bot`
5. **Save the Bot Token** (looks like: `123456789:ABCdefGHIjklMNOpqrsTUVwxyz`)

### Step 2: Install Required Library

```bash
pip install python-telegram-bot==20.7
```

### Step 3: Create Telegram Bot Handler

Create new file: `telegram_bot.py`

```python
import asyncio
from telegram import Bot
from telegram.error import TelegramError
import os

# Bot configuration
BOT_TOKEN = os.environ.get('TELEGRAM_BOT_TOKEN', 'YOUR_BOT_TOKEN_HERE')

class TelegramReportSender:
    def __init__(self, bot_token=BOT_TOKEN):
        self.bot = Bot(token=bot_token)
    
    async def send_report_async(self, username, report_data):
        """
        Send report to Telegram user
        
        Args:
            username: Telegram username (without @)
            report_data: Dictionary with system details
        
        Returns:
            (success: bool, message: str)
        """
        try:
            # Format report message
            message = self._format_report(report_data)
            
            # Get user's chat_id (requires user to start conversation first)
            # This is a simplified version - you'll need to implement
            # a proper user registration system
            chat_id = await self._get_chat_id(username)
            
            if chat_id:
                # Send message
                await self.bot.send_message(
                    chat_id=chat_id,
                    text=message,
                    parse_mode='HTML'
                )
                return True, f"Report sent successfully to @{username}"
            else:
                return False, f"User @{username} hasn't started conversation with bot yet"
                
        except TelegramError as e:
            return False, f"Telegram error: {str(e)}"
        except Exception as e:
            return False, f"Error: {str(e)}"
    
    def _format_report(self, data):
        """Format system data into readable message"""
        msg = f"""
üåû <b>KHSolar System Report</b>

üë§ <b>Customer:</b> {data.get('customer_name', 'N/A')}
üì± <b>Phone:</b> {data.get('phone', 'N/A')}

‚ö° <b>System Overview:</b>
‚Ä¢ Monthly Consumption: {data.get('monthly_kwh', 0)} kWh
‚Ä¢ Daily Average: {data.get('daily_kwh', 0)} kWh
‚Ä¢ System Type: {data.get('system_type', 'N/A')}

‚òÄÔ∏è <b>Solar Panels:</b>
‚Ä¢ Quantity: {data.get('num_panels', 0)} panels
‚Ä¢ Total Capacity: {data.get('pv_kw', 0)} kW

üîã <b>Battery Storage:</b>
‚Ä¢ Total Capacity: {data.get('battery_kwh', 0)} kWh
‚Ä¢ Backup Time: ~{data.get('backup_hours', 0)} hours

‚ö° <b>Inverter:</b>
‚Ä¢ Power Rating: {data.get('inverter_kw', 0)} kW
‚Ä¢ Type: {data.get('system_type', 'N/A')}

üí∞ <b>Investment:</b>
‚Ä¢ <b>Total Price: ${data.get('total_price', 0):,.2f}</b>
‚Ä¢ Monthly Savings: ${data.get('monthly_savings', 0):,.2f}
‚Ä¢ Annual Savings: ${data.get('annual_savings', 0):,.2f}
‚Ä¢ Payback Period: {data.get('payback_years', 0):.1f} years

üìä Generated by KHSolar System Designer
"""
        return msg
    
    async def _get_chat_id(self, username):
        """
        Get chat_id for username
        Note: This requires a database to store username -> chat_id mappings
        Users must first send /start to your bot
        """
        # TODO: Implement database lookup
        # For now, return None - you need to build registration system
        return None
    
    def send_report(self, username, report_data):
        """Synchronous wrapper for send_report_async"""
        return asyncio.run(self.send_report_async(username, report_data))

# Usage example:
# sender = TelegramReportSender()
# success, message = sender.send_report('username', report_data)
```

### Step 4: Update app.py

Replace the TODO section in `app.py` (around line 1641):

```python
# Telegram Report Sending
if st.session_state.customer_info.get('telegram'):
    st.markdown("<br>", unsafe_allow_html=True)
    telegram_username = st.session_state.customer_info['telegram']
    if st.button("üì§ Send Report to Telegram", type="secondary", use_container_width=True):
        try:
            from telegram_bot import TelegramReportSender
            
            # Prepare report data
            report_data = {
                'customer_name': st.session_state.customer_info['name'],
                'phone': st.session_state.customer_info['phone'],
                'monthly_kwh': results['monthly_kwh'],
                'daily_kwh': results['daily_kwh'],
                'system_type': results['system_type'],
                'num_panels': results['num_panels'],
                'pv_kw': results['pv_kw'],
                'battery_kwh': results['battery_kwh'],
                'backup_hours': (results['battery_kwh'] * 0.8 / results['daily_kwh'] * 24) if results['daily_kwh'] > 0 else 0,
                'inverter_kw': results['inverter_kw'],
                'total_price': results['total_customer'],
                'monthly_savings': monthly_savings,
                'annual_savings': annual_savings,
                'payback_years': payback_years
            }
            
            # Send report
            sender = TelegramReportSender()
            success, message = sender.send_report(telegram_username, report_data)
            
            if success:
                st.success(f"‚úÖ {message}")
            else:
                st.warning(f"‚ö†Ô∏è {message}")
                st.info("üí° Tip: User must send /start to @khsolar_reports_bot first")
                
        except ImportError:
            st.error("‚ùå Telegram bot module not found. Please install: pip install python-telegram-bot")
        except Exception as e:
            st.error(f"‚ùå Error: {str(e)}")
```

### Step 5: Create User Registration System

Create `bot_server.py` for handling user registrations:

```python
import asyncio
from telegram import Update
from telegram.ext import Application, CommandHandler, ContextTypes
import sqlite3

# Initialize database
def init_db():
    conn = sqlite3.connect('telegram_users.db')
    c = conn.cursor()
    c.execute('''CREATE TABLE IF NOT EXISTS users
                 (username TEXT PRIMARY KEY, chat_id INTEGER)''')
    conn.commit()
    conn.close()

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Handle /start command"""
    user = update.effective_user
    username = user.username
    chat_id = update.effective_chat.id
    
    if username:
        # Save to database
        conn = sqlite3.connect('telegram_users.db')
        c = conn.cursor()
        c.execute('INSERT OR REPLACE INTO users VALUES (?, ?)', (username, chat_id))
        conn.commit()
        conn.close()
        
        await update.message.reply_text(
            f"‚úÖ Welcome @{username}!\n\n"
            f"Your KHSolar account is now connected.\n"
            f"You will receive system reports here.\n\n"
            f"Chat ID: {chat_id}"
        )
    else:
        await update.message.reply_text(
            "‚ö†Ô∏è Please set a Telegram username in Settings first."
        )

def main():
    """Start the bot"""
    init_db()
    
    # Create application
    application = Application.builder().token("YOUR_BOT_TOKEN_HERE").build()
    
    # Add handlers
    application.add_handler(CommandHandler("start", start))
    
    # Start bot
    print("Bot started! Users can now send /start")
    application.run_polling()

if __name__ == '__main__':
    main()
```

### Step 6: Run Bot Server

```bash
python bot_server.py
```

Keep this running in background or use a process manager like `supervisor` or `systemd`.

---

## üîí Security Best Practices

### 1. **Environment Variables**
Store bot token securely:

```bash
# Linux/Mac
export TELEGRAM_BOT_TOKEN="your_bot_token_here"

# Windows
set TELEGRAM_BOT_TOKEN=your_bot_token_here
```

### 2. **Database Security**
- Use proper database (PostgreSQL, MySQL)
- Encrypt sensitive data
- Regular backups
- Access controls

### 3. **Rate Limiting**
Prevent spam:

```python
from time import time

last_send_time = {}

def can_send(username, cooldown=60):
    """Allow sending once per minute"""
    now = time()
    if username in last_send_time:
        if now - last_send_time[username] < cooldown:
            return False
    last_send_time[username] = now
    return True
```

---

## üìä User Flow

1. **Customer enters Telegram username** in KHSolar app
2. **Validation** checks username format
3. **Customer opens Telegram** and finds your bot
4. **Customer sends** `/start` to bot
5. **Bot saves** username ‚Üí chat_id mapping
6. **In KHSolar app**, customer clicks "Send Report to Telegram"
7. **Report is sent** to customer's Telegram
8. **Customer receives** formatted system report

---

## üß™ Testing

### Test Telegram Validation:
```python
# Valid
‚úÖ @john_doe
‚úÖ user123
‚úÖ test_user_2025

# Invalid
‚ùå abc (too short)
‚ùå user-name (hyphen not allowed)
‚ùå very_long_username_that_exceeds_32_chars
```

### Test Report Sending:
1. Create bot with @BotFather
2. Run `bot_server.py`
3. Send `/start` to bot from your account
4. Use KHSolar app with your Telegram username
5. Click "Send Report to Telegram"
6. Check Telegram for report message

---

## üìù Current Status

### ‚úÖ Completed:
- Telegram username input field
- Username validation (format, length)
- Clean username storage (without @)
- Display validated username in success message
- "Send Report to Telegram" button
- UI placement in Total System Price section

### üöß To Complete:
- Create Telegram bot with @BotFather
- Install python-telegram-bot library
- Create `telegram_bot.py` handler
- Create `bot_server.py` for registrations
- Set up database for username ‚Üí chat_id mapping
- Deploy bot server
- Update app.py with actual sending logic
- Add rate limiting
- Add error handling
- Add delivery confirmation

---

## üí° Alternative: Simple Link Method

If full bot integration is too complex, use this simpler approach:

```python
# In app.py, replace the button with:
telegram_username = st.session_state.customer_info['telegram']
telegram_url = f"https://t.me/{telegram_username}"
st.markdown(f"""
<a href="{telegram_url}" target="_blank">
    <button style="...">üì§ Contact on Telegram</button>
</a>
""", unsafe_allow_html=True)
```

This opens Telegram chat with customer - you can manually send report.

---

## üìû Support

For help setting up Telegram integration:
1. Check Telegram Bot API docs: https://core.telegram.org/bots/api
2. python-telegram-bot docs: https://docs.python-telegram-bot.org/
3. Test with @BotFather

---

**The validation and UI are ready - just need to complete the bot backend!** üöÄ
